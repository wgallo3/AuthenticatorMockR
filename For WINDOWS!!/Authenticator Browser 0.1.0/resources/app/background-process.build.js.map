{"version":3,"file":"background-process.build.js","sources":["app/env.js","app/background-process/api-manifests/sitedata.js","app/log.js","app/background-process/safe-storage/sitedata.js","app/background-process/safe-storage/settings.js","app/background-process/api-manifests/bookmarks.js","app/background-process/safe-storage/bookmarks.js","app/background-process/api-manifests/history.js","app/background-process/safe-storage/history.js","app/background-process/safe-storage/root-reducer.js","app/background-process/safe-storage/store.js","app/background-process/api-manifests/browser.js","app/background-process/plugins.js","app/background-process/browser.js","app/background-process/api-manifests/downloads.js","app/background-process/web-apis.js","app/background-process/ui/downloads.js","app/background-process/ui/permissions.js","app/background-process/ui/windows.js","app/background-process/ui/window-menu.js","app/background-process/ui/context-menu.js","app/background-process/protocols/beaker.js","app/background-process/protocols/beaker-favicon.js","app/background-process/open-url.js","app/background-process.js"],"sourcesContent":["// TODO - pull appropriately from build\r\n\r\nlet env = process.env.NODE_ENV || 'production'\r\n\r\nexport default {\r\n  name: env\r\n}","export default {\r\n  get: 'promise',\r\n  set: 'promise'\r\n}","import env from './env'\r\n\r\nexport default function log (...args) {\r\n  if (env.name !== 'production') {\r\n    console.log.apply(console, args)\r\n  }\r\n}","import { app, ipcMain } from 'electron'\r\nimport url from 'url'\r\nimport rpc from 'pauls-electron-rpc'\r\nimport manifest from '../api-manifests/sitedata'\r\nimport log from '../../log'\r\n\r\nimport store from './store'\r\nimport { createActions } from 'redux-actions'\r\nimport { List, Map, fromJS } from 'immutable'\r\n\r\n\r\n\r\n\r\nconst UPDATE_SITE_DATA = 'UPDATE_SITE_DATA'\r\n\r\nexport const { updateSiteData } = createActions( UPDATE_SITE_DATA )\r\n\r\nconst initialState = List([\r\n    Map( {\r\n        id: 'https:duckduckgo.com',\r\n        data : Map( {\r\n            favicon : `data:image/pngbase64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAACkklEQVQ4T22SXUiTURjH/+ds2jTNPiTbXC1jbtAYaAh97cKBYlpWk+gDFhQUeOFFYBdCXqwQirqT6KKiDzTqIjIZpKG4YQsligLN3FzYcCWDPtaG7vuceN+Xzb3mA+fiff7P//c8530OwRoRtOn7QIhdJnHerx3wn11dTvITC7ZqJzjXcgIHAW4DRCvpPMiBDsLhACHB7QNzrVlfDhA4pl8E5yegUHpUpjokpt+tNRw4YxYQ8lw36FcLBSIg0FrtpDTVw1AwGdfXQFVvg6axDZSlETxT+x+IIrWPsYJunXOulbjqoawq1U9wQuuESra5ArsejstMIccFxD6+keUIZ+/no/795OsRwwAl5BEHfylUFN8bx8jbn7C3mURDdCmJ7z8iWNd5UA4AOc44PycAOMDDANkoVBTddSOFIiSTaeh15aKp/eoLdPlugkX+5EEkD/EfFgArEXE8gbl2D8KRGMo3rc8JoesnodKOoaRmGQs3NMj8VYga8a0ChOpPwXL5mrS8TBhsRpODhMdL8XtIHDQXxNsiv0KivBLmx2MSIBUCm63CvKMSLE6h2pkQT9i9QVClK3xprnZSsH4OxbMs1vjKm+vgbTGiUJ1EiSmGxGIhlj4XSaMjc5qB2sU1VqgMLgJYsq6yB26o1eI7gddWCx5flo0tTgd4QnGfVXxIM01GF2XozlB4xNV13cFgQR/OmzqRmv6ED8O9mDhQho7eBRGkYLAwip7dr70SQIipRmOUAIdA4AnvbcJT6zfEUnFQutL80q2A0NrCgWHziLdUukpeTDUYXcJncpvu/uyVo/0NO2zYWqxBdNKVDnRftIMo2wXdPOq1Zm0ygJAU/skWpWGIgzTI1gU++ivta7a6kc7P/wNyZ/k5PvUO0QAAAABJRU5ErkJggg==`\r\n        })\r\n    })\r\n]) \r\n\r\n\r\n\r\n\r\n\r\nexport default function sitedata(state = initialState, action) \r\n{\r\n    let payload = fromJS(  action.payload )\r\n    \r\n    switch (action.type) {\r\n        case UPDATE_SITE_DATA :\r\n        {            \r\n            let index = state.findIndex( site => {\r\n                \r\n                return site.get('id') === payload.get( 'id' )\r\n                \r\n            })\r\n            \r\n            if( index > -1 )\r\n            {\r\n                let siteToMerge = state.get( index )\r\n                let updatedSite = siteToMerge.mergeDeep( payload )\r\n                \r\n                return state.set( index, updatedSite )\r\n            }\r\n            \r\n            return state.push( payload )\r\n        }\r\n        return\r\n        default:\r\n        return state\r\n    }\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\nexport function setup () {    \r\n    // wire up RPC\r\n    rpc.exportAPI('beakerSitedata', manifest, { get, set })\r\n}\r\n\r\nexport function set (url, key, value)\r\n{\r\n    let origin = extractOrigin(url)    \r\n    let sitedata = { id: origin, data: {} }\r\n    \r\n    sitedata.data[ key ] = value\r\n        \r\n    return new Promise( ( resolve, reject) =>\r\n    {\r\n        return store.dispatch( updateSiteData( sitedata ) )\r\n        \r\n    })\r\n    \r\n    \r\n}\r\n\r\nexport function get (url, key) {\r\n    var origin = extractOrigin(url)\r\n    let sitedata = { id: origin, key: key }\r\n    \r\n    return new Promise( ( resolve, reject) =>\r\n    {\r\n        let site = store.getState()[ 'sitedata' ].find( site => site.get('id') === origin ) \r\n        \r\n        if( site )\r\n        {\r\n            let datum = site.get( 'data' ).get( key )\r\n            resolve( datum )\r\n        }\r\n        else {\r\n            resolve( undefined )\r\n        }\r\n        \r\n        \r\n    })\r\n}\r\n\r\nfunction extractOrigin (originURL) {\r\n    var urlp = url.parse(originURL)\r\n    if (!urlp || !urlp.host || !urlp.protocol)\r\n    return\r\n    return (urlp.protocol + urlp.host + (urlp.port || ''))\r\n}\r\n\r\n","import { app } from 'electron'\r\nimport log from '../../log'\r\nimport store, { handleAuthError } from './store'\r\nimport { List, Map, fromJS } from 'immutable'\r\n\r\nimport { createActions } from 'redux-actions'\r\nimport { auth } from 'safe-js'\r\n\r\nconst UPDATE_SETTINGS = 'UPDATE_SETTINGS'\r\n\r\nexport const { updateSettings } = createActions( UPDATE_SETTINGS )\r\n\r\n\r\nconst initialState = Map( {\r\n\tauto_update_enabled: 0,\r\n\tauthMessage : 'Not attempted to connect yet'\r\n})\r\n\r\nexport default function settings(state = initialState, action) \r\n{\r\n\tlet payload = fromJS( action.payload )\r\n\t\r\n\tswitch (action.type) {\r\n\t\tcase UPDATE_SETTINGS :\r\n\t\t{\r\n\t\t\treturn state.mergeDeep( payload )\r\n\t\t}\r\n\t\treturn\r\n\t\tdefault:\r\n\t\treturn state\r\n\t}\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\nexport function set (key, value) \r\n{\r\n\treturn new Promise( (resolve, reject ) => \r\n\t{    \r\n\t\tlet setter = {}\r\n\t\tsetter[key] = value\r\n\t\tstore.dispatch( updateSettings( setter ) )\r\n\t})\r\n}\r\n\r\nexport function get (key) \r\n{\r\n\treturn new Promise( ( resolve, reject) =>\r\n\t{\r\n\t\tlet settings = store.getState()[ 'settings' ]\r\n\t\t\r\n\t\tif( settings )\r\n\t\t{\r\n\t\t\tlet result = settings.get( key )\r\n\t\t\tif( result )\r\n\t\t\t{\r\n\t\t\t\tresolve( settings.get( key ) )\r\n\t\t\t}\r\n\t\t\t\r\n\t\t}\r\n\t\telse {\r\n\t\t\tresolve( 'undefined' )\r\n\t\t}\r\n\t})\r\n\t\r\n}\r\n\r\n\r\nconst safeBrowserApp =\r\n{\r\n    //TODO: pull from package.json\r\n    name: \"SafeBrowser\",\r\n    id: \"safe-browser\",\r\n    version: \"0.4.0\",\r\n    vendor: \"josh.wilson\",\r\n    permissions : [ \"SAFE_DRIVE_ACCESS\"]\r\n}\r\n\r\n\r\n\r\nexport function reauthenticateSAFE () {\r\n\t\t\r\n\treturn auth.authorise( safeBrowserApp ).then( tok =>\r\n\t{\r\n\t\tstore.dispatch( updateSettings( { 'authSuccess': true } ) )\r\n\r\n\t\tstore.dispatch( updateSettings( { 'authToken' : tok.token } ) )\r\n\t\tstore.dispatch( updateSettings( { 'authMessage': 'Authorised with SAFE Launcher' } ) )\r\n\r\n\t} )\r\n\t// .catch( handleAuthError )\r\n}\r\n\r\nexport function getAll () {\r\n\treturn new Promise( ( resolve, reject) =>\r\n\t{\r\n\t\tlet settings = store.getState()[ 'settings' ]\r\n\t\t\r\n\t\tif( settings )\r\n\t\t{\r\n\t\t\tresolve( settings.toJS() )\r\n\t\t}\r\n\t\telse {\r\n\t\t\tresolve( {} )\r\n\t\t}\r\n\t})\r\n}\r\n","export default {\r\n  add: 'promise',\r\n  changeTitle: 'promise',\r\n  changeUrl: 'promise',\r\n  addVisit: 'promise',\r\n  remove: 'promise',\r\n  get: 'promise',\r\n  list: 'promise'\r\n}","import { app } from 'electron'\r\nimport url from 'url'\r\nimport rpc from 'pauls-electron-rpc'\r\nimport manifest from '../api-manifests/bookmarks'\r\nimport log from '../../log'\r\n\r\n\r\nimport store from './store'\r\nimport { List, Map, fromJS } from 'immutable'\r\nimport { createActions } from 'redux-actions'\r\n\r\nconst initialBookmarkState = List( [\r\n    Map( {\r\n        url: 'https://safenetforum.org/',\r\n        title : \"Safenet Forum\",\r\n        num_visits : 0\r\n    }),\r\n    Map( {\r\n        url: 'safe://dir.yvette/',\r\n        title : \"SAFE Network Directory\",\r\n        num_visits : 0\r\n    })\r\n] )\r\n\r\n\r\nconst UPDATE_BOOKMARK = 'UPDATE_BOOKMARK'\r\nconst DELETE_BOOKMARK = 'DELETE_BOOKMARK'\r\n\r\nexport const { updateBookmark, deleteBookmark } = createActions( UPDATE_BOOKMARK, DELETE_BOOKMARK )\r\n\r\nexport default function bookmarks(state = initialBookmarkState, action) {\r\n    let payload =  fromJS( action.payload ) \r\n    \r\n    if( action.error )\r\n    {\r\n        //trigger error action\r\n        return state\r\n    }\r\n\r\n    switch (action.type) {\r\n        case UPDATE_BOOKMARK :\r\n        {\r\n        \r\n            let newState\r\n            let newBookmarks\r\n            \r\n            let index = state.findIndex( site => {\r\n                return site.get('url') === payload.get( 'url' )\r\n            })\r\n            \r\n            if( index > -1 )\r\n            {\r\n                let siteToMerge = state.get( index )\r\n                let updatedSite = siteToMerge.mergeDeep( payload )\r\n\r\n                if( payload.get('newUrl') )\r\n                {\r\n                    updatedSite = updatedSite.set( 'url', payload.get('newUrl') )\r\n                }\r\n                \r\n                if( payload.get('num_visits') )\r\n                {\r\n                    let newVisitCount = siteToMerge.get('num_visits') || 0\r\n                    newVisitCount++\r\n                    updatedSite = updatedSite.set( 'num_visits', newVisitCount )\r\n                }\r\n                \r\n                return state.set( index, updatedSite )\r\n                \r\n            }\r\n            \r\n            if( payload.get( 'num_visits' ) )\r\n            {\r\n                return state\r\n            }\r\n            \r\n            return state.push( payload )\r\n        }\r\n        case DELETE_BOOKMARK: \r\n        {                         \r\n            let index = state.findIndex( site => site.get('url') === payload.get( 'url' ) )\r\n            \r\n            return state.delete( index )\r\n        } \r\n        default:\r\n            return state\r\n    }\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\nexport function setup () {\r\n  // wire up RPC\r\n  rpc.exportAPI('beakerBookmarks', manifest, { add, changeTitle, changeUrl, addVisit, remove, get, list })\r\n}\r\n\r\nexport function add (url, title) {\r\n    return new Promise( (resolve, reject) =>\r\n    {\r\n        let bookmark = { url, title }        \r\n        return store.dispatch( updateBookmark( bookmark ) )\r\n    } ) \r\n\r\n}\r\n\r\nexport function changeTitle (url, title) {\r\n    \r\n    return new Promise( (resolve, reject) =>\r\n    {\r\n        let bookmark = { url, title }\r\n        \r\n        return store.dispatch( updateBookmark( bookmark ) )\r\n    } ) \r\n}\r\n\r\nexport function changeUrl (oldUrl, newUrl) {\r\n\r\n    return new Promise( (resolve, reject) =>\r\n    {\r\n        let bookmark = { \r\n            url: oldUrl,\r\n            newUrl : newUrl }\r\n        \r\n        return store.dispatch( updateBookmark( bookmark ) )\r\n    } ) \r\n\r\n}\r\n\r\nexport function addVisit (url) {\r\n    \r\n    let site = store.getState()[ 'bookmarks' ].find( site => site.get('url') === url ) \r\n    if( site )\r\n    {\r\n        return new Promise( (resolve, reject) =>\r\n        {\r\n            let bookmark = { url, num_visits : 1 }\r\n            \r\n            return store.dispatch( updateBookmark( bookmark ) )\r\n        } ) \r\n        \r\n    }\r\n    else {\r\n        return Promise.reject('bookmark does not exist')\r\n    }\r\n\r\n\r\n}\r\n\r\nexport function remove (url) {\r\n\r\n    return new Promise( (resolve, reject) =>\r\n    {\r\n        let bookmark = { url }\r\n        \r\n        return store.dispatch( deleteBookmark( bookmark ) )\r\n    } ) \r\n}\r\n\r\nexport function get (url) {\r\n\r\n    return new Promise( ( resolve, reject) =>\r\n    {\r\n        let site = store.getState()[ 'bookmarks' ].find( site => site.get('url') === url ) \r\n\r\n        if( site )\r\n        {\r\n            let datum = site.get( 'data' ).get( key )\r\n            resolve( datum )\r\n        }\r\n        else {\r\n            resolve( undefined )\r\n        }\r\n    })\r\n    \r\n}\r\n\r\nexport function list () {\r\n\r\n    let sites = store.getState()[ 'bookmarks' ].toJS()\r\n    \r\n    return new Promise( (resolve, reject ) => resolve( sites ))\r\n\r\n}\r\n","export default {\r\n  addVisit: 'promise',\r\n  getVisitHistory: 'promise',\r\n  getMostVisited: 'promise',\r\n  search: 'promise',\r\n  removeVisit: 'promise',\r\n  removeAllVisits: 'promise'\r\n}","import { app, ipcMain } from 'electron'\r\nimport url from 'url'\r\nimport zerr from 'zerr'\r\nimport rpc from 'pauls-electron-rpc'\r\nimport manifest from '../api-manifests/history'\r\nimport log from '../../log'\r\n\r\nimport store from './store'\r\nimport { List, Map, fromJS } from 'immutable'\r\nimport { createAction, createActions } from 'redux-actions'\r\n\r\nconst BadParam = zerr('BadParam', '% must be a %')\r\nconst InvalidCmd = zerr('InvalidCommand', '% is not a valid command')\r\n\r\n\r\nconst initialHistoryState = List( [\r\n    Map( {\r\n        url: 'https://safenetforum.org/',\r\n        title : \"Safenet Forum\",\r\n        visits: List([]), \r\n        last_visit: new Date()\r\n        \r\n    })\r\n] )\r\n\r\n\r\n\r\nconst UPDATE_SITE = 'UPDATE_SITE'\r\nconst DELETE_SITE = 'DELETE_SITE'\r\nconst DELETE_ALL  = 'DELETE_ALL'\r\n\r\nexport const { updateSite, deleteSite, deleteAll } = createActions( UPDATE_SITE, DELETE_SITE, DELETE_ALL )\r\n\r\nexport default function history(state = initialHistoryState, action) {\r\n    let payload = fromJS(  action.payload )\r\n    \r\n    if( action.error )\r\n    {\r\n        return state\r\n    }\r\n    \r\n    switch (action.type) {\r\n        case UPDATE_SITE :\r\n        {    \r\n            let index = state.findIndex( site => {\r\n                return site.get('url') === payload.get( 'url' )\r\n            })\r\n            \r\n            if( index > -1 )\r\n            {\r\n                let siteToMerge = state.get( index )\r\n                let updatedSite = siteToMerge.mergeDeep( payload ) //updates last visit, url, title\r\n                let lastVisit   = payload.get('last_visit')\r\n                // // beter parsing of things that will be always there\r\n                if( payload.get('last_visit') && ! updatedSite.get('visits').includes( lastVisit ) )\r\n                {\r\n                    let updatedSiteVisits = updatedSite.get( 'visits' ).push( lastVisit )\r\n                    updatedSite = updatedSite.set( 'visits', updatedSiteVisits )\r\n                }\r\n                \r\n                updatedSite = updatedSite.set( 'last_visit', payload.get('last_visit') )\r\n\r\n                return state.set( index, updatedSite )\r\n\r\n            }\r\n            \r\n            payload = payload.set( 'visits', List([ payload.get('last_visit') ] ))\r\n            \r\n            return state.push( payload )\r\n        }\r\n        case DELETE_SITE: \r\n            {                \r\n                let index = state.findIndex( site => site.get('url') === payload.get( 'url' ) )\r\n                \r\n                return state.delete( index )\r\n            } \r\n        \r\n        case DELETE_ALL: \r\n            { \r\n                return state.clear()    \r\n            }\r\n        default:\r\n          return state\r\n  }\r\n  \r\n  \r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\nexport function setup () {\r\n  // wire up RPC\r\n  rpc.exportAPI('beakerHistory', manifest, { addVisit, getVisitHistory, getMostVisited, search, removeVisit, removeAllVisits })\r\n}\r\n\r\nexport function addVisit ( {url, title } ) {\r\n    // each visit has a timestamp\r\n    return new Promise( (resolve, reject ) =>\r\n    {\r\n        let site = { url, title, last_visit: new Date() }        \r\n        return store.dispatch( updateSite( site ) )\r\n    })\r\n}\r\n\r\nexport function getVisitHistory ({ offset, limit }) {\r\n    \r\n    return new Promise( (resolve, reject ) =>\r\n    {\r\n        let history = store.getState()[ 'history' ]\r\n        \r\n        let filteredHistory = history.filter( (value, key) => \r\n        {            \r\n            return ( key >= offset && key <= limit  )\r\n        } )\r\n                \r\n        if( filteredHistory )\r\n        {\r\n            resolve( filteredHistory.toJS() )\r\n        }\r\n        else {\r\n            resolve( undefined )\r\n        }\r\n    })\r\n}\r\n\r\nexport function getMostVisited ({ offset, limit }) {\r\n    \r\n    offset  = offset || 0\r\n    limit   = limit || 50\r\n     \r\n    return getVisitHistory( { offset, limit } )\r\n            .then( unsortedHistory => \r\n            {                \r\n                unsortedHistory.sort(function(a, b) {\r\n                    return b.visits.length - a.visits.length //high->low ??\r\n                })\r\n                \r\n                return unsortedHistory\r\n            })\r\n}\r\n\r\nexport function search (q) \r\n{    \r\n    let history = store.getState()[ 'history' ].toJS()\r\n    \r\n    let filteredHistory = history.filter( (value, key) => \r\n    {\r\n        return ( value.url.includes( q ) || value.title.includes( q ) )\r\n    } )\r\n    \r\n    //sort mby most should be a helper function.\r\n    filteredHistory = filteredHistory.sort(function(a, b) {\r\n        if( !a.visits || !b.visits )\r\n        { \r\n            return 1\r\n        }\r\n        else \r\n        {\r\n            return b.visits.length - a.visits.length //high->low ??\r\n        }\r\n    })\r\n    \r\n    return new Promise( (resolve, reject ) =>\r\n    {\r\n        resolve( filteredHistory )\r\n    })\r\n}\r\n\r\nexport function removeVisit (url) {\r\n    return new Promise( (resolve, reject) =>\r\n    {\r\n        let site = { url }\r\n        \r\n        return store.dispatch( deleteSite( site ) )\r\n    } ) \r\n}\r\n\r\nexport function removeAllVisits () {\r\n    \r\n    \r\n    return new Promise( (resolve, reject) =>\r\n    {        \r\n        return store.dispatch( deleteAll() )\r\n    } ) \r\n}\r\n    ","import { combineReducers } from 'redux'\r\nimport settings from './settings'\r\nimport sitedata from './sitedata'\r\nimport bookmarks from './bookmarks'\r\nimport history from './history'\r\n\r\n\r\nconst rootReducer = combineReducers({\r\n    \r\n    bookmarks\r\n    , history\r\n    , settings\r\n    , sitedata\r\n})\r\n\r\nexport default rootReducer\r\n","import { createStore, applyMiddleware, compose } from 'redux'\r\nimport thunk from 'redux-thunk'\r\nimport createNodeLogger from 'redux-node-logger'\r\nimport promiseMiddleware from 'redux-promise'\r\nimport _ from 'lodash'\r\n\r\nimport { updateSiteData } from './sitedata'\r\nimport { updateSettings } from './settings'\r\nimport { updateBookmark } from './bookmarks'\r\nimport { updateSite } from './history'\r\n\r\nimport rootReducer from './root-reducer'\r\nimport { nfs } from 'safe-js'\r\n\r\nexport const SITE_DATA_ID = 'safe:safe-browser'\r\nexport const SAFE_BROWSER_STATE_FILE = 'safeBrowserData.json'\r\n\r\n\r\nconst logger = createNodeLogger({\r\n    level: 'info',\r\n    collapsed: true\r\n})\r\n\r\nlet enhancer = compose(\r\n    applyMiddleware(thunk, logger, promiseMiddleware)\r\n)\r\n\r\nlet store = createStore(rootReducer, enhancer)\r\n\r\nexport default store;\r\n\r\n\r\n\r\nconst getTokenFromState = ( state = store.getState() ) =>\r\n{\r\n    let browserSettings = state[ 'settings' ]\r\n\r\n    if( browserSettings )\r\n    {\r\n        let authToken = browserSettings.get('authToken')\r\n                \r\n        if( authToken )\r\n        {\r\n            return authToken;\r\n            \r\n        }\r\n        else {\r\n            return null;\r\n        }\r\n        \r\n    }\r\n    else {\r\n        return null;\r\n    }\r\n}\r\n\r\n\r\nexport const getStore = ( token ) =>\r\n{\r\n    let currentToken = token || getTokenFromState()\r\n    \r\n    if( currentToken )\r\n    {\r\n        return nfs.getFile( currentToken, SAFE_BROWSER_STATE_FILE, 'json' )\r\n    }\r\n    else {\r\n        return Promise.reject( 'no token data found' )\r\n    }\r\n}\r\n\r\n\r\nconst save = ( ) =>\r\n{\r\n        let state = store.getState()\r\n        let currentToken = getTokenFromState( state )\r\n\r\n        if( currentToken )\r\n        {\r\n            let JSONToSave = JSON.stringify( state )\r\n            return nfs.createOrUpdateFile( currentToken, SAFE_BROWSER_STATE_FILE, JSONToSave, 'application/json' )\r\n                .then( bool => \r\n                    {\r\n                        console.log( \"success was had saving state:  \", bool )\r\n                        return bool\r\n                    } )\r\n        }\r\n        else {\r\n            return Promise.reject( new Error( 'Unable to save data to the SAFE network, as no token found' ) )\r\n        }\r\n}\r\n\r\nexport const saveStore = _.debounce( save, 500 );\r\n\r\n\r\n\r\n\r\n\r\nexport const reStore = ( storeState ) =>\r\n{\r\n    if( storeState.errorCode )\r\n    {\r\n        return Promise.reject( storeState )\r\n    }\r\n    \r\n    if( storeState.settings )\r\n    {\r\n        store.dispatch( updateSettings( storeState.settings ) )        \r\n\r\n    }\r\n    \r\n    if( storeState.sitedata )\r\n    {\r\n        dispatchForEach( storeState.sitedata , updateSiteData )\r\n    }\r\n    \r\n    if( storeState.history )\r\n    {\r\n        dispatchForEach( storeState.history , updateSite )\r\n    }\r\n    \r\n    if( storeState.bookmarks )\r\n    {\r\n        dispatchForEach( storeState.bookmarks , updateBookmark )\r\n    }\r\n    \r\n}\r\n\r\n\r\nconst dispatchForEach = ( array, action ) =>\r\n{\r\n    array.forEach( (item, key) => \r\n    {\r\n        store.dispatch( action( item ) )\r\n        return;\r\n    })\r\n}\r\n\r\n\r\n\r\n\r\n\r\nexport const handleAuthError = ( err ) =>\r\n{   \r\n    store.dispatch( updateSettings( { 'authSuccess': false} ) )\r\n    if( err.code === -12 )\r\n    {\r\n        store.dispatch( updateSettings( { 'authMessage': 'SAFE Launcher does not appear to be open.' } ) )\r\n        return\r\n    }\r\n    else if( err.code === 'ECONNREFUSED' )\r\n    {\r\n\t\tstore.dispatch( updateSettings( { 'authMessage': 'SAFE Launcher does not appear to be open.' } ) )\r\n        return\r\n    }\r\n    else if( err.statusText === 'Unauthorized' )\r\n    {\r\n\t\tstore.dispatch( updateSettings( { 'authMessage':'The browser failed to authorise with the SAFE launcher.' } ) )\r\n        return\r\n    }\r\n    \r\n    store.dispatch( updateSettings( { 'authMessage': '' + JSON.stringify( err ) } ) )\r\n}","export default {\r\n  eventsStream: 'readable',\r\n  getInfo: 'promise',\r\n  checkForUpdates: 'promise',\r\n  restartBrowser: 'sync',\r\n  reauthenticateSAFE: 'promise',\r\n\r\n  getSettings: 'promise',\r\n  getSetting: 'promise',\r\n  setSetting: 'promise',\r\n\r\n  listPlugins: 'promise',\r\n  lookupPlugin: 'promise',\r\n  installPlugin: 'promise',\r\n  uninstallPlugin: 'promise',\r\n\r\n  getHomePages: 'promise',\r\n  getProtocolDescription: 'sync',\r\n\r\n  getDefaultProtocolSettings: 'promise',\r\n  setAsDefaultProtocolClient: 'promise',\r\n  removeAsDefaultProtocolClient: 'promise'\r\n}\r\n","import { app, protocol } from 'electron'\r\nimport path from 'path'\r\nimport fs from 'fs'\r\nimport log from 'loglevel'\r\nimport rpc from 'pauls-electron-rpc'\r\nimport emitStream from 'emit-stream'\r\n\r\n// globals\r\n// =\r\nconst WITH_CALLBACK_TYPE_PREFIX = '_with_cb_';\r\n\r\nconst PLUGIN_NODE_MODULES = path.join(__dirname, 'node_modules')\r\nconsole.log('[PLUGINS] Loading from', PLUGIN_NODE_MODULES)\r\n\r\n// find all modules named beaker-plugin-*\r\nvar protocolModuleNames = []\r\ntry { protocolModuleNames = fs.readdirSync(PLUGIN_NODE_MODULES).filter(name => name.startsWith('beaker-plugin-')) }\r\ncatch (e) {}\r\n\r\n// load the plugin modules\r\nvar protocolModules = []\r\nvar protocolPackageJsons = {}\r\nprotocolModuleNames.forEach(name => {\r\n  // load module\r\n  try {\r\n    protocolModules.push(require(path.join(PLUGIN_NODE_MODULES, name)))\r\n  } catch (e) {\r\n    log.error('[PLUGINS] Failed to load plugin', name, e)\r\n    return\r\n  }\r\n\r\n  // load package.json\r\n  loadPackageJson(name)\r\n})\r\n\r\n// exported api\r\n// =\r\n\r\n// fetch a complete listing of the plugin info\r\n// - each plugin module can export arrays of values. this is a helper to create 1 list of all of them\r\nvar caches = {}\r\nexport function getAllInfo (key) {\r\n  // use cached\r\n  if (caches[key])\r\n    return caches[key]\r\n\r\n  // construct\r\n  caches[key] = []\r\n  protocolModules.forEach(protocolModule => {\r\n    if (!protocolModule[key])\r\n      return\r\n    // get the values from the module\r\n    var values = protocolModule[key]\r\n    if (!Array.isArray(values))\r\n      values = [values]\r\n\r\n    if (key === 'webAPIs') {\r\n      values = values.map(val => {\r\n        if (typeof val === 'object' && !val.scheme) {\r\n          val['scheme'] = protocolModule.protocols[0].scheme; // FIXME: for more than one scheme within plugin\r\n        }\r\n        return val;\r\n      });\r\n    }\r\n\r\n    // add to list\r\n    caches[key] = caches[key].concat(values)\r\n  })\r\n  return caches[key]\r\n}\r\n\r\n// register the protocols that have standard-url behaviors\r\n// - must be called before app 'ready'\r\nexport function registerStandardSchemes () {\r\n  var protos = getAllInfo('protocols')\r\n\r\n  // get the protocols that are 'standard'\r\n  var standardSchemes = protos.filter(desc => desc.isStandardURL).map(desc => desc.scheme)\r\n\r\n  // register\r\n  protocol.registerStandardSchemes(standardSchemes)\r\n}\r\n\r\n// register all protocol handlers\r\nexport function setupProtocolHandlers () {\r\n  getAllInfo('protocols').forEach(proto => {\r\n    // run the module's protocol setup\r\n    log.debug('Registering protocol handler:', proto.scheme)\r\n    proto.register()\r\n  })\r\n}\r\n\r\n// setup all web APIs\r\nexport function setupWebAPIs () {\r\n  getAllInfo('webAPIs').forEach(api => {\r\n    // run the module's protocol setup\r\n    log.debug('Wiring up Web API:', api.name)\r\n\r\n    // We export functions with callbacks in a separate channel\r\n    // since they will be adapted on the rederer side to invoke the callbacks\r\n    let fnsToExport = [];\r\n    let fnsWithCallbacks = [];\r\n    for (var fn in api.manifest) {\r\n      if (fn.startsWith(WITH_CALLBACK_TYPE_PREFIX)) {\r\n        fnsWithCallbacks[fn] = api.manifest[fn];\r\n      } else {\r\n        fnsToExport[fn] = api.manifest[fn];\r\n      }\r\n    }\r\n    rpc.exportAPI(api.name, fnsToExport, api.methods)\r\n    rpc.exportAPI(WITH_CALLBACK_TYPE_PREFIX + api.name, fnsWithCallbacks, api.methods) // FIXME: api.methods shall be probably chopped too\r\n  })\r\n}\r\n\r\n// get web API manifests for the given protocol\r\nexport function getWebAPIManifests (scheme) {\r\n  var manifests = {}\r\n\r\n  // massage input\r\n  scheme = scheme.replace(/:/g, '')\r\n\r\n  // get the protocol description\r\n  var proto = getAllInfo('protocols').find(proto => proto.scheme == scheme)\r\n  if (!proto)\r\n    return manifests\r\n\r\n  // collect manifests\r\n  getAllInfo('webAPIs').forEach(api => {\r\n    // just need to match isInternal for the api and the scheme\r\n    if ((api.isInternal == proto.isInternal) && (api.scheme === scheme))\r\n      manifests[api.name] = api.manifest\r\n  })\r\n  return manifests\r\n}\r\n\r\n// internal methods\r\n// =\r\n\r\nfunction loadPackageJson (name) {\r\n  var packageJson\r\n  try { packageJson = extractPackageJsonAttrs(require(path.join(PLUGIN_NODE_MODULES, name, 'package.json'))) }\r\n  catch (e) { packageJson = { name: name, status: 'installed' } }\r\n  protocolPackageJsons[name] = packageJson\r\n}\r\n\r\nfunction extractPackageJsonAttrs (packageJson) {\r\n  return {\r\n    name: packageJson.name,\r\n    author: packageJson.author,\r\n    description: packageJson.description,\r\n    homepage: packageJson.homepage,\r\n    version: packageJson.version,\r\n    status: 'installed'\r\n  }\r\n}\r\n","import { app, protocol, autoUpdater, session } from 'electron'\r\nimport os from 'os'\r\nimport rpc from 'pauls-electron-rpc'\r\nimport emitStream from 'emit-stream'\r\nimport EventEmitter from 'events'\r\nimport path from 'path'\r\nimport fs from 'fs'\r\nimport log from 'loglevel'\r\nimport globalModulesDir from 'global-modules'\r\nimport co from 'co'\r\nimport manifest from './api-manifests/browser'\r\nimport { cbPromise } from '../lib/functions'\r\nimport * as settingsDb from './safe-storage/settings'\r\nimport * as plugins from './plugins'\r\n\r\n// constants\r\n// =\r\n\r\n// how long between scheduled auto updates?\r\nconst SCHEDULED_AUTO_UPDATE_DELAY = 24 * 60 * 60 * 1e3 // once a day\r\n\r\n// possible updater states\r\nconst UPDATER_STATUS_IDLE = 'idle'\r\nconst UPDATER_STATUS_CHECKING = 'checking'\r\nconst UPDATER_STATUS_DOWNLOADING = 'downloading'\r\nconst UPDATER_STATUS_DOWNLOADED = 'downloaded'\r\n\r\n// globals\r\n// =\r\n\r\n// what's the updater doing?\r\nvar updaterState = UPDATER_STATUS_IDLE\r\nvar updaterError = false // has there been an error?\r\n\r\n// is the updater available? must be on certain platform, and may be disabled if there's an error\r\nvar isBrowserUpdatesSupported = (os.platform() == 'darwin' || os.platform() == 'win32')\r\n\r\n// events emitted to rpc clients\r\nvar browserEvents = new EventEmitter()\r\n\r\n// exported methods\r\n// =\r\n\r\nexport function setup () {\r\n  // setup auto-updater\r\n  try {\r\n    if (!isBrowserUpdatesSupported)\r\n      throw new Error('Disabled. Only available on macOS and Windows.')\r\n    autoUpdater.setFeedURL(getAutoUpdaterFeedURL())\r\n    autoUpdater.once('update-available', onUpdateAvailable)\r\n    autoUpdater.on('error', onUpdateError)\r\n  } catch (e) {\r\n    log.error('[AUTO-UPDATE]', e.toString())\r\n    isBrowserUpdatesSupported = false\r\n  }\r\n  setTimeout(scheduledAutoUpdate, 15e3) // wait 15s for first run\r\n\r\n  // wire up RPC\r\n  rpc.exportAPI('beakerBrowser', manifest, {\r\n    eventsStream,\r\n    getInfo,\r\n    checkForUpdates,\r\n    restartBrowser,\r\n    reauthenticateSAFE,\r\n    getSetting,\r\n    getSettings,\r\n    setSetting,\r\n\r\n    getProtocolDescription,\r\n    getHomePages,\r\n\r\n    getDefaultProtocolSettings,\r\n    setAsDefaultProtocolClient,\r\n    removeAsDefaultProtocolClient\r\n  })\r\n}\r\n\r\nexport function getDefaultProtocolSettings () {\r\n  return Promise.resolve(['http', 'dat', 'ipfs', 'view-dat'].reduce((res, x) => {\r\n    res[x] = app.isDefaultProtocolClient(x)\r\n    return res\r\n  }, {}))\r\n}\r\n\r\nexport function setAsDefaultProtocolClient (protocol) {\r\n  return Promise.resolve(app.setAsDefaultProtocolClient(protocol))\r\n}\r\n\r\nexport function removeAsDefaultProtocolClient (protocol) {\r\n  return Promise.resolve(app.removeAsDefaultProtocolClient(protocol))\r\n}\r\n\r\nexport function getInfo () {\r\n  return Promise.resolve({\r\n    version: app.getVersion(),\r\n    platform: os.platform(),\r\n    updater: {\r\n      isBrowserUpdatesSupported,\r\n      error: updaterError,\r\n      state: updaterState\r\n    },\r\n    paths: {\r\n      userData: app.getPath('userData')\r\n    }\r\n  })\r\n}\r\n\r\n// this method was written, as it is, when there was an in-app plugins installer\r\n// since it works well enough, and the in-app installer may return, Im leaving it this way\r\n// ... but, that would explain the somewhat odd design\r\n// -prf\r\nexport function checkForUpdates () {\r\n  // dont overlap\r\n  if (updaterState != UPDATER_STATUS_IDLE)\r\n    return\r\n\r\n  // track result states for this run\r\n  var isBrowserChecking = false // still checking?\r\n  var isBrowserUpdated = false  // got an update?\r\n\r\n  // update global state\r\n  log.debug('[AUTO-UPDATE] Checking for a new version.')\r\n  updaterError = false\r\n  setUpdaterState(UPDATER_STATUS_CHECKING)\r\n\r\n  if (isBrowserUpdatesSupported) {\r\n    // check the browser auto-updater\r\n    // - because we need to merge the electron auto-updater, and the npm plugin flow...\r\n    //   ... it's best to set the result events here\r\n    //   (see note above -- back when there WAS a plugin updater, this made since -prf)\r\n    isBrowserChecking = true\r\n    autoUpdater.checkForUpdates()\r\n    autoUpdater.once('update-not-available', () => {\r\n      log.debug('[AUTO-UPDATE] No browser update available.')\r\n      isBrowserChecking = false\r\n      checkDone()\r\n    })\r\n    autoUpdater.once('update-downloaded', () => {\r\n      log.debug('[AUTO-UPDATE] New browser version downloaded. Ready to install.')\r\n      isBrowserChecking = false\r\n      isBrowserUpdated = true\r\n      checkDone()\r\n    })\r\n\r\n    // cleanup\r\n    autoUpdater.once('update-not-available', removeAutoUpdaterListeners)\r\n    autoUpdater.once('update-downloaded', removeAutoUpdaterListeners)\r\n    function removeAutoUpdaterListeners () {\r\n      autoUpdater.removeAllListeners('update-not-available')\r\n      autoUpdater.removeAllListeners('update-downloaded')\r\n    }\r\n  }\r\n\r\n  // check the result states and emit accordingly\r\n  function checkDone () {\r\n    if (isBrowserChecking)\r\n      return // still checking\r\n\r\n    // done, emit based on result\r\n    if (isBrowserUpdated) {\r\n      setUpdaterState(UPDATER_STATUS_DOWNLOADED)\r\n    } else {\r\n      setUpdaterState(UPDATER_STATUS_IDLE)\r\n    }\r\n  }\r\n\r\n  // just return a resolve; results will be emitted\r\n  return Promise.resolve()\r\n}\r\n\r\nexport function restartBrowser () {\r\n  if (updaterState == UPDATER_STATUS_DOWNLOADED) {\r\n    // run the update installer\r\n    autoUpdater.quitAndInstall()\r\n    log.debug('[AUTO-UPDATE] Quitting and installing.')\r\n  } else {\r\n    log.debug('Restarting Beaker by restartBrowser()')\r\n    // do a simple restart\r\n    app.relaunch()\r\n    setTimeout(() => app.exit(0), 1e3)\r\n  }\r\n}\r\n\r\nexport function getSetting (key) {\r\n  return settingsDb.get(key)\r\n}\r\n\r\nexport function reauthenticateSAFE () {\r\n  return settingsDb.reauthenticateSAFE()\r\n}\r\n\r\nexport function getSettings () {\r\n  return settingsDb.getAll()\r\n}\r\n\r\nexport function setSetting (key, value) {\r\n  return settingsDb.set(key, value)\r\n}\r\n\r\n// get the home-page listing\r\nexport function getHomePages () {\r\n  return Promise.resolve(plugins.getAllInfo('homePages'))\r\n}\r\n\r\n// get the description for a given scheme\r\nexport function getProtocolDescription (scheme) {\r\n  // massage input\r\n  scheme = scheme.replace(/:/g, '')\r\n\r\n  // find desc\r\n  return plugins.getAllInfo('protocols').find(proto => proto.scheme == scheme)\r\n}\r\n\r\n// rpc methods\r\n// =\r\n\r\nfunction eventsStream () {\r\n  return emitStream(browserEvents)\r\n}\r\n\r\n// internal methods\r\n// =\r\n\r\nfunction setUpdaterState (state) {\r\n  updaterState = state\r\n  browserEvents.emit('updater-state-changed', state)\r\n}\r\n\r\nfunction getAutoUpdaterFeedURL () {\r\n  if (os.platform() == 'darwin') {\r\n    return 'https://download.beakerbrowser.net/update/osx/'+app.getVersion()\r\n  }\r\n  else if (os.platform() == 'win32') {\r\n    let bits = (os.arch().indexOf('64') === -1) ? 32 : 64\r\n    return 'https://download.beakerbrowser.net/update/win'+bits+'/'+app.getVersion()\r\n  }\r\n}\r\n\r\n// run a daily check for new updates\r\nfunction scheduledAutoUpdate () {\r\n  settingsDb.get('auto_update_enabled').then(v => {\r\n    // if auto updates are enabled, run the check\r\n    if (+v === 1)\r\n      checkForUpdates()\r\n\r\n    // schedule next check\r\n    setTimeout(scheduledAutoUpdate, SCHEDULED_AUTO_UPDATE_DELAY)\r\n  })\r\n}\r\n\r\n// event handlers\r\n// =\r\n\r\nfunction onUpdateAvailable () {\r\n  // update status and emit, so the frontend can update\r\n  log.debug('[AUTO-UPDATE] New version available. Downloading...')\r\n  setUpdaterState(UPDATER_STATUS_DOWNLOADING)\r\n}\r\n\r\nfunction onUpdateError (e) {\r\n  log.error('[AUTO-UPDATE]', e.toString())\r\n  setUpdaterState(UPDATER_STATUS_IDLE)\r\n  updaterError = e.toString()\r\n  browserEvents.emit('updater-error', e.toString())\r\n}\r\n","export default {\r\n  eventsStream: 'readable',\r\n  getDownloads: 'promise',\r\n  pause: 'promise',\r\n  resume: 'promise',\r\n  cancel: 'promise',\r\n  remove: 'promise',\r\n  open: 'promise',\r\n  showInFolder: 'promise'\r\n}","import { ipcMain } from 'electron'\r\nimport beakerBrowser from './api-manifests/browser'\r\nimport beakerBookmarks from './api-manifests/bookmarks'\r\nimport beakerDownloads from './api-manifests/downloads'\r\nimport beakerHistory from './api-manifests/history'\r\nimport beakerSitedata from './api-manifests/sitedata'\r\nimport * as plugins from './plugins'\r\n\r\n// dat-plugin is an optional internal dependency\r\nvar datPlugin\r\ntry {\r\n  datPlugin = require('beaker-plugin-dat')\r\n} catch (e){}\r\n\r\n// exported api\r\n// =\r\n\r\nexport function setup () {\r\n  // register a message-handler for setting up the client\r\n  // - see lib/fg/import-web-apis.js\r\n  ipcMain.on('get-web-api-manifests', (event, scheme) => {\r\n    // hardcode the beaker: scheme, since that's purely for internal use\r\n    if (scheme == 'beaker:') {\r\n      var protos = { \r\n        beakerBrowser,\r\n        beakerBookmarks,\r\n        beakerDownloads,\r\n        beakerHistory,\r\n        beakerSitedata\r\n      }\r\n      if (datPlugin && datPlugin.webAPIs[0])\r\n        protos.datInternalAPI = datPlugin.webAPIs[0].manifest\r\n      event.returnValue = protos\r\n      return\r\n    }\r\n\r\n    // for everything else, we'll use the plugins\r\n    event.returnValue = plugins.getWebAPIManifests(scheme)\r\n  })\r\n}","import path from 'path'\r\nimport fs from 'fs'\r\nimport { app, dialog, shell } from 'electron'\r\nimport unusedFilename from 'unused-filename'\r\nimport speedometer from 'speedometer'\r\nimport emitStream from 'emit-stream'\r\nimport EventEmitter from 'events'\r\nimport rpc from 'pauls-electron-rpc'\r\nimport manifest from '../api-manifests/downloads'\r\n\r\n// globals\r\n// =\r\n\r\n// downloads list\r\n// - shared across all windows\r\nvar downloads = []\r\n\r\n// used for rpc\r\nvar downloadsEvents = new EventEmitter()\r\n\r\n// exported api\r\n// =\r\n\r\nexport function setup () {\r\n  // wire up RPC\r\n  rpc.exportAPI('beakerDownloads', manifest, { eventsStream, getDownloads, pause, resume, cancel, remove, open, showInFolder })\r\n}\r\n\r\nexport function registerListener (win, opts = {}) {\r\n  const listener = (e, item, webContents) => {\r\n    // dont touch if already being handled\r\n    // - if `opts.saveAs` is being used, there may be multiple active event handlers\r\n    if (item.isHandled)\r\n      return\r\n\r\n    // build a path to an unused name in the downloads folder\r\n    const filePath = opts.saveAs ? opts.saveAs : unusedFilename.sync(path.join(app.getPath('downloads'), item.getFilename()))\r\n\r\n    // track as an active download\r\n    item.id = (''+Date.now())+(''+Math.random()) // pretty sure this is collision proof but replace if not -prf\r\n    item.name = path.basename(filePath)\r\n    item.setSavePath(filePath)\r\n    item.isHandled = true\r\n    item.downloadSpeed = speedometer()\r\n    downloads.push(item)\r\n    downloadsEvents.emit('new-download', toJSON(item))\r\n\r\n    // TODO: use mime type checking for file extension when no extension can be inferred\r\n    // item.getMimeType()\r\n\r\n    // update dock-icon progress bar\r\n    var lastBytes = 0\r\n    item.on('updated', () => {\r\n      var sumProgress = {\r\n        receivedBytes: getSumReceivedBytes(),\r\n        totalBytes: getSumTotalBytes()\r\n      }\r\n\r\n      // track rate of download\r\n      item.downloadSpeed(item.getReceivedBytes() - lastBytes)\r\n      lastBytes = item.getReceivedBytes()\r\n\r\n      // emit\r\n      downloadsEvents.emit('updated', toJSON(item))\r\n      downloadsEvents.emit('sum-progress', sumProgress)\r\n      win.setProgressBar(sumProgress.receivedBytes / sumProgress.totalBytes)\r\n    })\r\n\r\n    item.on('done', (e, state) => {\r\n      downloadsEvents.emit('done', toJSON(item))\r\n\r\n      // replace entry with a clone that captures the final state\r\n      downloads.splice(downloads.indexOf(item), 1, capture(item))\r\n\r\n      // reset progress bar when done\r\n      if (isNoActiveDownloads() && !win.isDestroyed()) {\r\n        win.setProgressBar(-1)\r\n      }\r\n\r\n      // inform users of error conditions\r\n      if (state === 'interrupted') {\r\n        dialog.showErrorBox('Download error', `The download of ${item.getFilename()} was interrupted`)\r\n      }\r\n\r\n      if (state === 'completed') {\r\n        // flash the dock on osx\r\n        if (process.platform === 'darwin') {\r\n          app.dock.downloadFinished(filePath)\r\n        }\r\n\r\n        // optional, for one-time downloads\r\n        if (opts.unregisterWhenDone) {\r\n          webContents.session.removeListener('will-download', listener)\r\n        }\r\n      }\r\n    })\r\n  }\r\n\r\n  win.webContents.session.prependListener('will-download', listener)\r\n  win.on('close', () => win.webContents.session.removeListener('will-download', listener))\r\n}\r\n\r\nexport function download (win, url, opts) {\r\n  // register for onetime use of the download system\r\n  opts = Object.assign({}, opts, {unregisterWhenDone: true})\r\n  registerListener(win, opts)\r\n  win.webContents.downloadURL(url)\r\n}\r\n\r\n// rpc api\r\n// =\r\n\r\nfunction eventsStream () {\r\n  return emitStream(downloadsEvents)\r\n}\r\n\r\nfunction getDownloads () {\r\n  return Promise.resolve(downloads.map(toJSON))\r\n}\r\n\r\nfunction pause (id) {\r\n  var download = downloads.find(d => d.id == id)\r\n  if (download)\r\n    download.pause()\r\n  return Promise.resolve()\r\n}\r\n\r\nfunction resume (id) {\r\n  var download = downloads.find(d => d.id == id)\r\n  if (download)\r\n    download.resume()\r\n  return Promise.resolve()\r\n}\r\n\r\nfunction cancel (id) {\r\n  var download = downloads.find(d => d.id == id)\r\n  if (download)\r\n    download.cancel()\r\n  return Promise.resolve()\r\n}\r\n\r\nfunction remove (id) {\r\n  var download = downloads.find(d => d.id == id)\r\n  if (download && download.getState() != 'progressing')\r\n    downloads.splice(downloads.indexOf(download), 1)\r\n  return Promise.resolve()\r\n}\r\n\r\nfunction open (id) {\r\n  return new Promise((resolve, reject) => {\r\n    // find the download\r\n    var download = downloads.find(d => d.id == id)\r\n    if (!download || download.state != 'completed')\r\n      return reject()\r\n\r\n    // make sure the file is still there\r\n    fs.stat(download.getSavePath(), err => {\r\n      if (err)\r\n        return reject()\r\n\r\n      // open\r\n      shell.openItem(download.getSavePath())\r\n      resolve()\r\n    })\r\n  })\r\n}\r\n\r\nfunction showInFolder (id) {\r\n  return new Promise((resolve, reject) => {\r\n    // find the download\r\n    var download = downloads.find(d => d.id == id)\r\n    if (!download || download.state != 'completed')\r\n      return reject()\r\n\r\n    // make sure the file is still there\r\n    fs.stat(download.getSavePath(), err => {\r\n      if (err)\r\n        return reject()\r\n\r\n      // open\r\n      shell.showItemInFolder(download.getSavePath())\r\n      resolve()\r\n    })\r\n  })\r\n}\r\n\r\n// internal helpers\r\n// =\r\n\r\n// reduce down to attributes\r\nfunction toJSON (item) {\r\n  return {\r\n    id: item.id,\r\n    name: item.name,\r\n    url: item.getURL(),\r\n    state: item.getState(),\r\n    isPaused: item.isPaused(),\r\n    receivedBytes: item.getReceivedBytes(),\r\n    totalBytes: item.getTotalBytes(),\r\n    downloadSpeed: item.downloadSpeed()\r\n  }\r\n}\r\n\r\n// create a capture of the final state of an item\r\nfunction capture (item) {\r\n  var savePath = item.getSavePath()\r\n  var dlspeed = item.download\r\n  item = toJSON(item)\r\n  item.getURL = () => item.url\r\n  item.getState = () => item.state\r\n  item.isPaused = () => false\r\n  item.getReceivedBytes = () => item.receivedBytes\r\n  item.getTotalBytes = () => item.totalBytes\r\n  item.getSavePath = () => savePath\r\n  item.downloadSpeed = () => dlspeed\r\n  return item\r\n}\r\n\r\n// sum of received bytes\r\nfunction getSumReceivedBytes () {\r\n  return getActiveDownloads().reduce((acc, item) => acc + item.getReceivedBytes(), 0) \r\n}\r\n\r\n// sum of total bytes\r\nfunction getSumTotalBytes () {\r\n  return getActiveDownloads().reduce((acc, item) => acc + item.getTotalBytes(), 0) \r\n}\r\n\r\nfunction getActiveDownloads () {\r\n  return downloads.filter(d => d.getState() == 'progressing')\r\n}\r\n\r\n// all downloads done?\r\nfunction isNoActiveDownloads () {\r\n  return getActiveDownloads().length === 0\r\n}","import { ipcMain, session, BrowserWindow } from 'electron'\r\nimport log from '../../log'\r\n\r\n// globals\r\n// =\r\n\r\nvar idCounter = 0\r\nvar activeRequests = []\r\n\r\n// exported api\r\n// =\r\n\r\nexport function setup () {\r\n  // wire up handlers\r\n  session.defaultSession.setPermissionRequestHandler(onPermissionRequestHandler)\r\n  ipcMain.on('permission-response', onPermissionResponseHandler)\r\n}\r\n\r\nexport function denyAllRequests (win) {\r\n  // remove all requests in the window, denying as we go \r\n  activeRequests = activeRequests.filter(req => {\r\n    if (req.win === win) {\r\n      log('Denying outstanding permission for closing window, req #'+req.id+' for '+req.permission)\r\n      req.cb(false)\r\n      return false\r\n    }\r\n    return true\r\n  })\r\n}\r\n\r\n// event handlers\r\n// =\r\n\r\nfunction onPermissionRequestHandler (webContents, permission, cb) {\r\n  // look up the containing window\r\n  var win = BrowserWindow.fromWebContents(webContents.hostWebContents)\r\n  if (!win)\r\n    return log('Warning: failed to find containing window of permission request, '+permission)\r\n\r\n  // if we're already tracking this kind of permission request, then bundle them\r\n  var req = activeRequests.find(req => req.win === win && req.permission === permission)\r\n  if (req) {\r\n    var oldCb = req.cb\r\n    req.cb = decision => { oldCb(decision); cb(decision) }\r\n  } else {\r\n    // track the new cb\r\n    var req = { id: ++idCounter, win, permission, cb }\r\n    activeRequests.push(req)\r\n  }\r\n\r\n  // send message to create the UI\r\n  win.webContents.send('command', 'perms:prompt', req.id, webContents.id, permission)\r\n}\r\n\r\nfunction onPermissionResponseHandler (e, reqId, decision) {\r\n  var win = e.sender\r\n\r\n  // lookup the cb\r\n  var req = activeRequests.find(req => req.id == reqId)\r\n  if (!req)\r\n    return log('Warning: failed to find permission request for response #'+reqId)\r\n\r\n  // untrack\r\n  activeRequests.splice(activeRequests.indexOf(req), 1)\r\n\r\n  // hand down the decision\r\n  var cb = req.cb\r\n  cb(decision)\r\n}","import { app, BrowserWindow, screen, ipcMain } from 'electron'\r\nimport { register as registerShortcut, unregisterAll as unregisterAllShortcuts } from 'electron-localshortcut'\r\nimport jetpack from 'fs-jetpack'\r\nimport path from 'path'\r\nimport * as downloads from './downloads'\r\nimport * as permissions from './permissions'\r\nimport log from '../../log'\r\nimport url from 'url'\r\nimport electronLocalshortcut from 'electron-localshortcut'\r\n\r\nimport store, { saveStore } from '../safe-storage/store'\r\n\r\n// globals\r\n// =\r\nvar userDataDir\r\nvar stateStoreFile = 'shell-window-state.json'\r\nvar numActiveWindows = 0\r\n\r\n// exported methods\r\n// =\r\n\r\nexport function setup () {\r\n  // config\r\n  userDataDir = jetpack.cwd(app.getPath('userData'))\r\n\r\n  // load pinned tabs\r\n  ipcMain.on('shell-window-ready', e => {\r\n    // if this is the first window opened (since app start or since all windows closing)\r\n    if (numActiveWindows === 1) {\r\n      e.sender.webContents.send('command', 'load-pinned-tabs')\r\n    }\r\n  })\r\n\r\n  // create first shell window\r\n  return createShellWindow()\r\n}\r\n\r\nexport function createShellWindow () {\r\n  // create window\r\n  var { x, y, width, height } = ensureVisibleOnSomeDisplay(restoreState())\r\n  var win = new BrowserWindow({ \r\n    titleBarStyle: 'hidden-inset',\r\n    'standard-window': false,\r\n    x, y, width, height,\r\n    webPreferences: {\r\n      webSecurity: false, // disable same-origin-policy in the shell window, webviews have it restored\r\n      allowRunningInsecureContent: false\r\n    }\r\n  })\r\n\r\n\r\n    //safe filter\r\n    let filter = {\r\n        urls: ['http://*/*', 'https://*/*' ]\r\n      \r\n    }\r\n    win.webContents.session.webRequest.onBeforeRequest(filter, (details, callback) => \r\n    {\r\n        const parsedUrl = url.parse(details.url)\r\n        \r\n        if( typeof(win.webContents.isSafe) === 'undefined' )\r\n        {\r\n            win.webContents.isSafe = true\r\n        }\r\n       \r\n        if( ! win.webContents.isSafe || parsedUrl.host.indexOf( 'localhost' ) === 0 )\r\n        {\r\n            callback({})\r\n            return\r\n        }\r\n            \r\n        if( details.url.indexOf('http') > -1 )\r\n        {\r\n          callback({ cancel: true })\r\n          \r\n        }\r\n    })\r\n    \r\n    //extra shortcuts outside of menus\r\n    electronLocalshortcut.register(win, 'Alt+D', () => \r\n    {\r\n        if (win) win.webContents.send('command', 'file:open-location')\r\n    })\r\n  \r\n    \r\n    store.subscribe( e => \r\n    {        \r\n        saveStore();    \r\n        win.webContents.send('safeStore-updated')\r\n\r\n    })\r\n\r\n  \r\n  \r\n  downloads.registerListener(win)\r\n  loadURL(win, 'beaker:shell-window')\r\n  numActiveWindows++\r\n\r\n  // register shortcuts\r\n  for (var i=1; i <= 9; i++)\r\n    registerShortcut(win, 'CmdOrCtrl+'+i, onTabSelect(win, i-1))\r\n  registerShortcut(win, 'Ctrl+Tab', onNextTab(win))\r\n  registerShortcut(win, 'Ctrl+Shift+Tab', onPrevTab(win))\r\n\r\n  // register event handlers\r\n  win.on('scroll-touch-begin', sendToWebContents('scroll-touch-begin'))\r\n  win.on('scroll-touch-end', sendToWebContents('scroll-touch-end'))\r\n  win.on('focus', sendToWebContents('focus'))\r\n  win.on('blur', sendToWebContents('blur'))\r\n  win.on('enter-full-screen', sendToWebContents('enter-full-screen'))\r\n  win.on('leave-full-screen', sendToWebContents('leave-full-screen'))\r\n  win.on('close', onClose(win))\r\n\r\n  return win\r\n}\r\n\r\n// internal methods\r\n// =\r\n\r\nfunction loadURL (win, url) {\r\n  win.loadURL(url)\r\n  log('Opening', url)  \r\n}\r\n\r\nfunction getCurrentPosition (win) {\r\n  var position = win.getPosition()\r\n  var size = win.getSize()\r\n  return {\r\n    x: position[0],\r\n    y: position[1],\r\n    width: size[0],\r\n    height: size[1]\r\n  }\r\n}\r\n\r\nfunction windowWithinBounds (windowState, bounds) {\r\n  return windowState.x >= bounds.x &&\r\n    windowState.y >= bounds.y &&\r\n    windowState.x + windowState.width <= bounds.x + bounds.width &&\r\n    windowState.y + windowState.height <= bounds.y + bounds.height\r\n}\r\n\r\nfunction restoreState () {\r\n  var restoredState = {}\r\n  try {\r\n    restoredState = userDataDir.read(stateStoreFile, 'json')\r\n  } catch (err) {\r\n    // For some reason json can't be read (might be corrupted).\r\n    // No worries, we have defaults.\r\n  }\r\n  return Object.assign({}, defaultState(), restoredState)\r\n}\r\n\r\nfunction defaultState () {\r\n  var bounds = screen.getPrimaryDisplay().bounds\r\n  var width = Math.max(800, Math.min(1800, bounds.width - 50))\r\n  var height = Math.max(600, Math.min(1200, bounds.height - 50))\r\n  return Object.assign({}, {\r\n    x: (bounds.width - width) / 2,\r\n    y: (bounds.height - height) / 2,\r\n    width,\r\n    height\r\n  })\r\n}\r\n\r\nfunction ensureVisibleOnSomeDisplay (windowState) {\r\n  var visible = screen.getAllDisplays().some(display => windowWithinBounds(windowState, display.bounds))\r\n  if (!visible) {\r\n    // Window is partially or fully not visible now.\r\n    // Reset it to safe defaults.\r\n    return defaultState(windowState)\r\n  }\r\n  return windowState\r\n}\r\n\r\nfunction onClose (win) {\r\n  return e => {\r\n    numActiveWindows--\r\n\r\n    // deny any outstanding permission requests\r\n    permissions.denyAllRequests(win)\r\n\r\n    // unregister shortcuts\r\n    unregisterAllShortcuts(win)\r\n\r\n    // save state\r\n    // NOTE this is called by .on('close')\r\n    // if quitting multiple windows at once, the final saved state is unpredictable\r\n    if (!win.isMinimized() && !win.isMaximized()) {\r\n      var state = getCurrentPosition(win)\r\n      userDataDir.write(stateStoreFile, state, { atomic: true })\r\n    }\r\n  }\r\n}\r\n\r\n// shortcut event handlers\r\n// =\r\n\r\nfunction onTabSelect (win, tabIndex) {\r\n  return () => win.webContents.send('command', 'set-tab', tabIndex)\r\n}\r\n\r\nfunction onNextTab (win) {\r\n  return () => win.webContents.send('command', 'window:next-tab')\r\n}\r\nfunction onPrevTab (win) {\r\n  return () => win.webContents.send('command', 'window:prev-tab')\r\n}\r\n\r\n// window event handlers\r\n// =\r\n\r\nfunction sendToWebContents (event) {\r\n  return e => e.sender.webContents.send('window-event', event)\r\n}","import { app, BrowserWindow, dialog } from 'electron'\r\nimport { createShellWindow } from './windows'\r\n\r\nvar darwinMenu = {\r\n  label: 'Beaker',\r\n  submenu: [\r\n    { label: 'About Beaker', role: 'about' },\r\n    { type: 'separator' },\r\n    { label: 'Services', role: 'services', submenu: [] },\r\n    { type: 'separator' },\r\n    { label: 'Hide Beaker', accelerator: 'Command+H', role: 'hide' },\r\n    { label: 'Hide Others', accelerator: 'Command+Alt+H', role: 'hideothers' },\r\n    { label: 'Show All', role: 'unhide' },\r\n    { type: 'separator' },\r\n    { label: 'Quit', accelerator: 'Command+Q', click() { app.quit() } }\r\n  ]\r\n}\r\n\r\nvar fileMenu = {\r\n  label: 'File',\r\n  submenu: [\r\n    {\r\n      label: 'New Tab',\r\n      accelerator: 'CmdOrCtrl+T',\r\n      click: function (item, win) {\r\n        if (win) win.webContents.send('command', 'file:new-tab')\r\n      }\r\n    },\r\n    {\r\n      label: 'New Window',\r\n      accelerator: 'CmdOrCtrl+N',\r\n      click: function () { createShellWindow() }\r\n    },\r\n    {\r\n      label: 'Reopen Closed Tab',\r\n      accelerator: 'CmdOrCtrl+Shift+T',\r\n      click: function (item, win) {\r\n        if (win) win.webContents.send('command', 'file:reopen-closed-tab')\r\n      }\r\n    },\r\n    {\r\n      label: 'Toggle SAFE Browsing',\r\n      checked: true,\r\n      accelerator: 'CmdOrCtrl+Shift+L',\r\n      click: function (item, win) {\r\n          if (win) win.webContents.send('command', 'window:toggle-safe-mode')\r\n      }\r\n    },\r\n    {\r\n      label: 'Open File',\r\n      accelerator: 'CmdOrCtrl+O',\r\n      click: function (item, win) {\r\n        if (win) {\r\n          dialog.showOpenDialog({ title: 'Open file...', properties: ['openFile', 'createDirectory'] }, files => {\r\n            if (files && files[0])\r\n              win.webContents.send('command', 'file:new-tab', 'file://'+files[0])\r\n          })\r\n        }\r\n      }\r\n    },\r\n    {\r\n      label: 'Open Location',\r\n      accelerator: 'CmdOrCtrl+L',\r\n      click: function (item, win) {\r\n        if (win) win.webContents.send('command', 'file:open-location')\r\n      }\r\n    },\r\n    { type: 'separator' },\r\n    {\r\n      label: 'Close Window',\r\n      accelerator: 'CmdOrCtrl+Shift+W',\r\n      click: function (item, win) {\r\n        if (win) win.close()\r\n      }\r\n    },\r\n    {\r\n      label: 'Close Tab',\r\n      accelerator: 'CmdOrCtrl+W',\r\n      click: function (item, win) {\r\n        if (win) win.webContents.send('command', 'file:close-tab')\r\n      }\r\n    }\r\n  ]\r\n}\r\n\r\nvar editMenu = {\r\n  label: 'Edit',\r\n  submenu: [\r\n    { label: \"Undo\", accelerator: \"CmdOrCtrl+Z\", selector: \"undo:\" },\r\n    { label: \"Redo\", accelerator: \"Shift+CmdOrCtrl+Z\", selector: \"redo:\" },\r\n    { type: \"separator\" },\r\n    { label: \"Cut\", accelerator: \"CmdOrCtrl+X\", selector: \"cut:\" },\r\n    { label: \"Copy\", accelerator: \"CmdOrCtrl+C\", selector: \"copy:\" },\r\n    { label: \"Paste\", accelerator: \"CmdOrCtrl+V\", selector: \"paste:\" },\r\n    { label: \"Select All\", accelerator: \"CmdOrCtrl+A\", selector: \"selectAll:\" },\r\n    {\r\n      label: \"Find in Page\",\r\n      accelerator: \"CmdOrCtrl+F\",\r\n      click: function (item, win) {\r\n        if (win) win.webContents.send('command', 'edit:find')\r\n      }\r\n    }\r\n  ]\r\n}\r\n\r\nvar viewMenu = {\r\n  label: 'View',\r\n  submenu: [{\r\n    label: 'Reload',\r\n    accelerator: 'CmdOrCtrl+R',\r\n    click: function (item, win) {\r\n      if (win) win.webContents.send('command', 'view:reload') \r\n    }\r\n  },\r\n  {\r\n    label: 'Hard Reload (Clear Cache)',\r\n    accelerator: 'CmdOrCtrl+Shift+R',\r\n    click: function (item, win) {\r\n      if (win) win.webContents.send('command', 'view:hard-reload') \r\n    }\r\n  },\r\n  { type: \"separator\" },\r\n  {\r\n    label: 'Zoom In',\r\n    accelerator: 'CmdOrCtrl+=',\r\n    click: function (item, win) {\r\n      if (win) win.webContents.send('command', 'view:zoom-in') \r\n    }\r\n  },\r\n  {\r\n    label: 'Zoom Out',\r\n    accelerator: 'CmdOrCtrl+-',\r\n    click: function (item, win) {\r\n      if (win) win.webContents.send('command', 'view:zoom-out') \r\n    }\r\n  },\r\n  {\r\n    label: 'Actual Size',\r\n    accelerator: 'CmdOrCtrl+0',\r\n    click: function (item, win) {\r\n      if (win) win.webContents.send('command', 'view:zoom-reset') \r\n    }\r\n  },\r\n  { type: \"separator\" },\r\n  {\r\n    label: 'Toggle DevTools',\r\n    accelerator: 'Alt+CmdOrCtrl+I',\r\n    click: function (item, win) {\r\n      if (win) win.webContents.send('command', 'view:toggle-dev-tools') \r\n    }\r\n  }]\r\n}\r\n\r\nvar historyMenu = {\r\n  label: 'History',\r\n  role: 'history',\r\n  submenu: [\r\n    {\r\n      label: 'Back',\r\n      accelerator: 'CmdOrCtrl+Left',\r\n      click: function (item, win) {\r\n        if (win) win.webContents.send('command', 'history:back')\r\n      }\r\n    },\r\n    {\r\n      label: 'Forward',\r\n      accelerator: 'CmdOrCtrl+Right',\r\n      click: function (item, win) {\r\n        if (win) win.webContents.send('command', 'history:forward')\r\n      }\r\n    }\r\n  ]\r\n}\r\n\r\nvar windowMenu = {\r\n  label: 'Window',\r\n  role: 'window',\r\n  submenu: [\r\n    {\r\n      label: 'Minimize',\r\n      accelerator: 'CmdOrCtrl+M',\r\n      role: 'minimize'\r\n    },\r\n    {\r\n      label: 'Close',\r\n      accelerator: 'CmdOrCtrl+Q',\r\n      role: 'close'\r\n    },\r\n    {\r\n      label: 'Next Tab',\r\n      accelerator: 'CmdOrCtrl+]',\r\n      click: function (item, win) {\r\n        if (win) win.webContents.send('command', 'window:next-tab')\r\n      }\r\n    },\r\n    {\r\n      label: 'Previous Tab',\r\n      accelerator: 'CmdOrCtrl+[',\r\n      click: function (item, win) {\r\n        if (win) win.webContents.send('command', 'window:prev-tab')\r\n      }\r\n    }\r\n  ]\r\n}\r\nif (process.platform == 'darwin') {\r\n  windowMenu.submenu.push({\r\n    type: 'separator'\r\n  })\r\n  windowMenu.submenu.push({\r\n    label: 'Bring All to Front',\r\n    role: 'front'\r\n  })\r\n}\r\n\r\n\r\nvar beakerDevMenu = {\r\n  label: 'BeakerDev',\r\n  submenu: [{\r\n    label: 'Reload Shell-Window',\r\n    click: function () {\r\n      BrowserWindow.getFocusedWindow().webContents.reloadIgnoringCache()\r\n    }\r\n  },{\r\n    label: 'Toggle Shell-Window DevTools',\r\n    click: function () {\r\n      BrowserWindow.getFocusedWindow().toggleDevTools()\r\n    }\r\n  },{\r\n    label: 'Toggle WebSecurity for new tabs',\r\n    click: function ( item, win ) {\r\n        if (win) win.webContents.send('command', 'window:disable-web-security' )\r\n    }\r\n  }]\r\n}\r\n\r\nexport default function buildWindowMenu (env) {\r\n  var menus = [fileMenu, editMenu, viewMenu, historyMenu, windowMenu]\r\n  if (process.platform === 'darwin') menus.unshift(darwinMenu)\r\n  if (env.name !== 'production') menus.push(beakerDevMenu)\r\n  return menus\r\n}","import { app, Menu, clipboard, BrowserWindow, dialog } from 'electron'\r\nimport url from 'url'\r\nimport path from 'path'\r\nimport { download } from './downloads'\r\nimport { getProtocolDescription } from '../browser'\r\n\r\nexport default function registerContextMenu () {\r\n  // register the context menu on every created webContents\r\n  app.on('web-contents-created', (e, webContents) => {\r\n    webContents.on('context-menu', (e, props) => {\r\n      var menuItems = []\r\n      const { mediaFlags, editFlags } = props\r\n      const hasText = props.selectionText.trim().length > 0\r\n      const can = type => editFlags[`can${type}`] && hasText\r\n\r\n      // get the focused window, ignore if not available (not in focus)\r\n      // - fromWebContents(webContents) doesnt seem to work, maybe because webContents is often a webview?\r\n      var targetWindow = BrowserWindow.getFocusedWindow()\r\n      if (!targetWindow)\r\n        return\r\n\r\n      // ignore clicks on the shell window\r\n      if (props.pageURL == 'beaker:shell-window')\r\n        return\r\n\r\n      // helper to call code on the element under the cursor\r\n      const callOnElement = js => {\r\n        webContents.executeJavaScript(`\r\n          var el = document.elementFromPoint(${props.x}, ${props.y})\r\n          ${js}\r\n        `)\r\n      }\r\n\r\n      // helper to run a download prompt for media\r\n      const downloadPrompt = (item, win) => {\r\n        var defaultPath = path.join(app.getPath('downloads'), path.basename(props.srcURL))\r\n        dialog.showSaveDialog({ title: `Save ${props.mediaType} as...`, defaultPath }, filepath => {\r\n          if (filepath)\r\n            download(win, props.srcURL, { saveAs: filepath })\r\n        })\r\n      }\r\n\r\n      // links\r\n      if (props.linkURL && props.mediaType === 'none') {\r\n        menuItems.push({ label: 'Open Link in New Tab', click: (item, win) => win.webContents.send('command', 'file:new-tab', props.linkURL) })\r\n        menuItems.push({ label: 'Copy Link Address', click: () => clipboard.writeText(props.linkURL) })\r\n        menuItems.push({ type: 'separator' })\r\n      }\r\n\r\n      // images\r\n      if (props.mediaType == 'image') {\r\n        menuItems.push({ label: 'Save Image As...', click: downloadPrompt })\r\n        menuItems.push({ label: 'Copy Image', click: () => webContents.copyImageAt(props.x, props.y) })\r\n        menuItems.push({ label: 'Copy Image URL', click: () => clipboard.writeText(props.srcURL) })\r\n        menuItems.push({ label: 'Open Image in New Tab', click: (item, win) => win.webContents.send('command', 'file:new-tab', props.srcURL) })\r\n        menuItems.push({ type: 'separator' })\r\n      }\r\n\r\n      // videos and audios\r\n      if (props.mediaType == 'video' || props.mediaType == 'audio') {\r\n        menuItems.push({ label: 'Loop', type: 'checkbox', checked: mediaFlags.isLooping, click: () => callOnElement('el.loop = !el.loop') })\r\n        if (mediaFlags.hasAudio)\r\n          menuItems.push({ label: 'Muted', type: 'checkbox', checked: mediaFlags.isMuted, click: () => callOnElement('el.muted = !el.muted') })\r\n        if (mediaFlags.canToggleControls)\r\n          menuItems.push({ label: 'Show Controls', type: 'checkbox', checked: mediaFlags.isControlsVisible, click: () => callOnElement('el.controls = !el.controls') })\r\n        menuItems.push({ type: 'separator' })\r\n      }\r\n\r\n      // videos\r\n      if (props.mediaType == 'video') {\r\n        menuItems.push({ label: 'Save Video As...', click: downloadPrompt })\r\n        menuItems.push({ label: 'Copy Video URL', click: () => clipboard.writeText(props.srcURL) })\r\n        menuItems.push({ label: 'Open Video in New Tab', click: (item, win) => win.webContents.send('command', 'file:new-tab', props.srcURL) })\r\n        menuItems.push({ type: 'separator' })\r\n      }\r\n\r\n      // audios\r\n      if (props.mediaType == 'audio') {\r\n        menuItems.push({ label: 'Save Audio As...', click: downloadPrompt })\r\n        menuItems.push({ label: 'Copy Audio URL', click: () => clipboard.writeText(props.srcURL) })\r\n        menuItems.push({ label: 'Open Audio in New Tab', click: (item, win) => win.webContents.send('command', 'file:new-tab', props.srcURL) })\r\n        menuItems.push({ type: 'separator' })\r\n      }\r\n\r\n      // clipboard\r\n      if (props.isEditable) {\r\n        menuItems.push({ label: 'Cut', role: 'cut', enabled: can('Cut') })\r\n        menuItems.push({ label: 'Copy', role: 'copy', enabled: can('Copy') })\r\n        menuItems.push({ label: 'Paste', role: 'paste', enabled: editFlags.canPaste })\r\n        menuItems.push({ type: 'separator' })\r\n      }\r\n      else if (hasText) {\r\n        menuItems.push({ label: 'Copy', role: 'copy', enabled: can('Copy') })\r\n        menuItems.push({ type: 'separator' })      \r\n      }\r\n\r\n      // inspector\r\n      menuItems.push({ label: 'Inspect Element', click: item => {\r\n        webContents.inspectElement(props.x, props.y)\r\n        if (webContents.isDevToolsOpened())\r\n          webContents.devToolsWebContents.focus()\r\n      }})\r\n\r\n      // protocol\r\n      var urlp = url.parse(props.frameURL||props.pageURL)\r\n      var pdesc = getProtocolDescription(urlp.protocol)\r\n      if (pdesc && pdesc.contextMenu && Array.isArray(pdesc.contextMenu)) {\r\n        menuItems.push({ type: 'separator' })\r\n        pdesc.contextMenu.forEach(item => {\r\n          menuItems.push({\r\n            label: item.label,\r\n            click: (_, win) => item.click(win, props)\r\n          })\r\n        })\r\n      }\r\n\r\n      // show menu\r\n      var menu = Menu.buildFromTemplate(menuItems)\r\n      menu.popup(targetWindow)\r\n    })\r\n  })\r\n}","import { protocol, shell } from 'electron'\r\nimport path from 'path'\r\n\r\nexport function setup () {\r\n  protocol.registerFileProtocol('beaker', (request, cb) => {\r\n    // FIXME\r\n    // if-casing every possible asset is pretty dumb\r\n    // generalize this\r\n    // -prf\r\n\r\n    // browser ui\r\n    if (request.url == 'beaker:shell-window')\r\n      return cb(path.join(__dirname, 'shell-window.html'))\r\n    if (request.url == 'beaker:shell-window.js')\r\n      return cb(path.join(__dirname, 'shell-window.build.js'))\r\n    if (request.url == 'beaker:shell-window.css')\r\n      return cb(path.join(__dirname, 'stylesheets/shell-window.css'))\r\n\r\n    // builtin pages\r\n    for (let slug of ['start', 'favorites', 'archives', 'history', 'downloads', 'settings']) {\r\n      if (request.url == `beaker:${slug}`)\r\n        return cb(path.join(__dirname, 'builtin-pages.html'))\r\n    }\r\n    if (request.url.startsWith('beaker:site/'))\r\n      return cb(path.join(__dirname, 'builtin-pages.html'))\r\n    if (request.url == 'beaker:builtin-pages.js')\r\n      return cb(path.join(__dirname, 'builtin-pages.build.js'))\r\n    if (request.url == 'beaker:builtin-pages.css')\r\n      return cb(path.join(__dirname, 'stylesheets/builtin-pages.css'))\r\n\r\n    // common assets\r\n    if (request.url == 'beaker:font')\r\n      return cb(path.join(__dirname, 'fonts/photon-entypo.woff'))\r\n    if (request.url.startsWith('beaker:logo'))\r\n      return cb(path.join(__dirname, 'img/logo.png'))\r\n    if (request.url.startsWith('beaker:safe-auth-logo'))\r\n      return cb(path.join(__dirname, 'img/safe_auth_logo.svg'))\r\n    if (request.url.startsWith('beaker:safe-auth-home'))\r\n      return cb(shell.openExternal('safe-auth://home/'))\r\n\r\n    return cb(-6)\r\n  }, e => {\r\n    if (e)\r\n      console.error('Failed to register beaker protocol', e)\r\n  });\r\n}","/**\r\n * beaker-favicon:\r\n *\r\n * Helper protocol to serve site favicons from the sitedata db.\r\n **/\r\n\r\nimport { protocol } from 'electron'\r\nimport fs from 'fs'\r\nimport path from 'path'\r\nimport * as sitedata from '../safe-storage/sitedata'\r\n\r\nexport function setup () {\r\n  // load default favicon\r\n  var defaultFaviconBuffer = -6 // not found, till we load it\r\n  fs.readFile(path.join(__dirname, './img/default-favicon.ico'), (err, buf) => {\r\n    if (err)\r\n      console.log('Failed to load default favicon', path.join(__dirname, '../../img/default-favicon.ico'), err)\r\n    if (buf)\r\n      defaultFaviconBuffer = buf\r\n  })\r\n\r\n  // load logo favicon\r\n  var logoBuffer = -6 // not found, till we load it\r\n  fs.readFile(path.join(__dirname, './img/logo-favicon.png'), (err, buf) => {\r\n    if (err)\r\n      console.log('Failed to load logo favicon', path.join(__dirname, '../../img/logo.png'), err)\r\n    if (buf)\r\n      logoBuffer = buf\r\n  })\r\n\r\n  // register favicon protocol\r\n  protocol.registerBufferProtocol('beaker-favicon', (request, cb) => {\r\n    var url = request.url.slice('beaker-favicon:'.length)\r\n\r\n    // special case\r\n    if (url == 'beaker')\r\n      return cb(logoBuffer)\r\n\r\n    // look up in db\r\n    sitedata.get(url, 'favicon').then(data => {\r\n      if (data) {\r\n        // `data` is a data url ('data:image/png;base64,...')\r\n        // so, skip the beginning and pull out the data\r\n        data = data.split(',')[1]\r\n        if (data)\r\n          return cb(new Buffer(data, 'base64'))\r\n      }\r\n      cb(defaultFaviconBuffer)\r\n    }).catch(err => cb(defaultFaviconBuffer))\r\n  }, e => {\r\n    if (e)\r\n      console.error('Failed to register beaker-favicon protocol', e)\r\n  });\r\n}","// handle OSX open-url event\r\nimport { ipcMain } from 'electron'\r\nvar queue = []\r\nvar commandReceiver\r\n\r\nexport function setup () {\r\n  ipcMain.once('shell-window-ready', function (e) {\r\n    commandReceiver = e.sender\r\n    queue.forEach(url => commandReceiver.send('command', 'file:new-tab', url))\r\n    queue.length = 0\r\n  })\r\n}\r\n\r\nexport function open (url) {\r\n  if (commandReceiver) {\r\n    commandReceiver.send('command', 'file:new-tab', url)\r\n  } else {\r\n    queue.push(url)\r\n  }\r\n}\r\n","// This is main process of Electron, started as first thing when your\r\n// app starts. This script is running through entire life of your application.\r\n// It doesn't have any windows which you can see on screen, but we can open\r\n// window from here.\r\n\r\nimport { app, BrowserWindow, Menu } from 'electron'\r\nimport log from 'loglevel'\r\nimport env from './env'\r\n\r\nimport store, { getStore, reStore, saveStore, handleAuthError } from './background-process/safe-storage/store'\r\n\r\n// set setting does not trigger save\r\nimport { updateSettings } from './background-process/safe-storage/settings'\r\n\r\nimport * as beakerBrowser from './background-process/browser'\r\nimport * as plugins from './background-process/plugins'\r\nimport * as webAPIs from './background-process/web-apis'\r\nimport * as windows from './background-process/ui/windows'\r\nimport buildWindowMenu from './background-process/ui/window-menu'\r\nimport registerContextMenu from './background-process/ui/context-menu'\r\nimport * as downloads from './background-process/ui/downloads'\r\nimport * as permissions from './background-process/ui/permissions'\r\nimport * as settings from './background-process/safe-storage/settings'\r\nimport * as sitedata from './background-process/safe-storage/sitedata'\r\nimport * as bookmarks from './background-process/safe-storage/bookmarks'\r\nimport * as history from './background-process/safe-storage/history'\r\n\r\nimport * as beakerProtocol from './background-process/protocols/beaker'\r\nimport * as beakerFaviconProtocol from './background-process/protocols/beaker-favicon'\r\n\r\nimport * as openURL from './background-process/open-url'\r\n\r\nimport { auth } from 'safe-js'\r\n// import packageJson from './package.json'\r\nvar packageJson = require( './package.json' );\r\nvar mainWindow = null;\r\n\r\nconsole.log( \"packagejson\" );\r\n\r\nconst parseSafeUri = function(uri) {\r\n  return uri.replace('//', '').replace('==/', '==');\r\n};\r\n\r\nconst safeBrowserApp =\r\n{\r\n    name: packageJson.name,\r\n    id: packageJson.name,\r\n    version: packageJson.version,\r\n    vendor: packageJson.author.name,\r\n    permissions : [ \"SAFE_DRIVE_ACCESS\"]\r\n};\r\n\r\n\r\n\r\n\r\n// // configure logging\r\nlog.setLevel('trace')\r\n\r\n// load the installed protocols\r\nplugins.registerStandardSchemes()\r\n\r\napp.on('ready', function () {\r\n\r\n    let token = auth.authorise( safeBrowserApp ).then( tok =>\r\n  {\r\n        store.dispatch( updateSettings( { 'authSuccess': true } ) )\r\n        store.dispatch( updateSettings( { 'authToken' : tok.token } ) )\r\n        store.dispatch( updateSettings( { 'authMessage': 'Authorised with SAFE Launcher' } ) )\r\n\r\n        getStore( tok.token )\r\n            .then( json =>\r\n            {\r\n                reStore( json )\r\n\r\n            })\r\n            .catch( err =>\r\n            {\r\n                if( err.status === 404)\r\n                {\r\n                    store.dispatch( updateSettings( { 'authMessage': 'Authorised with SAFE Launcher'  } ) )\r\n                }\r\n                else {\r\n\r\n                    store.dispatch( updateSettings( { 'authMessage': 'Problems getting browser settings from the network, ' + err.staus + ', ' + err.statusText  } ) )\r\n                }\r\n            })\r\n\r\n  })\r\n  .catch( handleAuthError )\r\n\r\n  // API initialisations\r\n  sitedata.setup()\r\n  bookmarks.setup()\r\n  history.setup()\r\n\r\n  // base\r\n  beakerBrowser.setup()\r\n\r\n  // ui\r\n  Menu.setApplicationMenu(Menu.buildFromTemplate(buildWindowMenu(env)))\r\n  registerContextMenu()\r\n  windows.setup()\r\n  downloads.setup()\r\n  permissions.setup()\r\n\r\n  // protocols\r\n  beakerProtocol.setup()\r\n  beakerFaviconProtocol.setup()\r\n  plugins.setupProtocolHandlers()\r\n\r\n  // web APIs\r\n  webAPIs.setup()\r\n  plugins.setupWebAPIs()\r\n\r\n  // listen OSX open-url event\r\n  openURL.setup()\r\n\r\n  if((process.platform === 'linux') || (process.platform === 'win32')) {\r\n    if (process.argv[1] && (process.argv[1].indexOf('safe') !== -1)) {\r\n      openURL.open(parseSafeUri(process.argv[1]))\r\n    }\r\n  }\r\n\r\n  const shouldQuit = app.makeSingleInstance(function(commandLine, workingDirectory) {\r\n    if (commandLine.length >= 2 && commandLine[1]) {\r\n      openURL.open(parseSafeUri(commandLine[1]));\r\n    }\r\n\r\n    mainWindow = BrowserWindow.getFocusedWindow() || BrowserWindow.getAllWindows()[0]\r\n\r\n    // Someone tried to run a second instance, we should focus our window\r\n    if (mainWindow) {\r\n      if (mainWindow.isMinimized()) mainWindow.restore();\r\n      mainWindow.focus();\r\n    }\r\n  });\r\n\r\n  if (shouldQuit) {\r\n    app.quit();\r\n  }\r\n})\r\n\r\napp.on('window-all-closed', function () {\r\n  if (process.platform !== 'darwin')\r\n    app.quit()\r\n})\r\n\r\napp.on('open-url', function (e, url) {\r\n  openURL.open(url)\r\n})\r\n"],"names":["env","process","NODE_ENV","log","args","name","apply","console","UPDATE_SITE_DATA","updateSiteData","createActions","initialState","List","Map","sitedata","state","action","payload","fromJS","type","index","findIndex","site","get","siteToMerge","updatedSite","mergeDeep","set","push","setup","exportAPI","manifest","url","key","value","origin","extractOrigin","id","data","Promise","resolve","reject","store","dispatch","getState","find","datum","undefined","originURL","urlp","parse","host","protocol","port","UPDATE_SETTINGS","updateSettings","settings","setter","result","safeBrowserApp","reauthenticateSAFE","auth","authorise","then","tok","token","getAll","toJS","initialBookmarkState","UPDATE_BOOKMARK","DELETE_BOOKMARK","updateBookmark","deleteBookmark","bookmarks","error","newState","newBookmarks","newVisitCount","delete","add","changeTitle","changeUrl","addVisit","remove","list","title","bookmark","oldUrl","newUrl","num_visits","sites","BadParam","zerr","InvalidCmd","initialHistoryState","Date","UPDATE_SITE","DELETE_SITE","DELETE_ALL","updateSite","deleteSite","deleteAll","history","lastVisit","includes","updatedSiteVisits","clear","getVisitHistory","getMostVisited","search","removeVisit","removeAllVisits","last_visit","offset","limit","filteredHistory","filter","unsortedHistory","sort","a","b","visits","length","q","rootReducer","combineReducers","SAFE_BROWSER_STATE_FILE","logger","createNodeLogger","enhancer","compose","applyMiddleware","thunk","promiseMiddleware","createStore","getTokenFromState","browserSettings","authToken","getStore","currentToken","nfs","getFile","save","JSONToSave","JSON","stringify","createOrUpdateFile","bool","Error","saveStore","_","debounce","reStore","storeState","errorCode","dispatchForEach","array","forEach","item","handleAuthError","err","code","statusText","WITH_CALLBACK_TYPE_PREFIX","PLUGIN_NODE_MODULES","path","join","__dirname","protocolModuleNames","fs","readdirSync","startsWith","e","protocolModules","protocolPackageJsons","require","caches","getAllInfo","protocolModule","values","Array","isArray","map","val","scheme","protocols","concat","registerStandardSchemes","protos","standardSchemes","desc","isStandardURL","setupProtocolHandlers","proto","debug","register","setupWebAPIs","api","fnsToExport","fnsWithCallbacks","fn","methods","getWebAPIManifests","manifests","replace","isInternal","loadPackageJson","packageJson","extractPackageJsonAttrs","status","author","description","homepage","version","SCHEDULED_AUTO_UPDATE_DELAY","UPDATER_STATUS_IDLE","UPDATER_STATUS_CHECKING","UPDATER_STATUS_DOWNLOADING","UPDATER_STATUS_DOWNLOADED","updaterState","updaterError","isBrowserUpdatesSupported","os","platform","browserEvents","EventEmitter","setFeedURL","getAutoUpdaterFeedURL","once","onUpdateAvailable","on","onUpdateError","toString","scheduledAutoUpdate","getDefaultProtocolSettings","reduce","res","x","app","isDefaultProtocolClient","setAsDefaultProtocolClient","removeAsDefaultProtocolClient","getInfo","getVersion","getPath","checkForUpdates","isBrowserChecking","isBrowserUpdated","removeAutoUpdaterListeners","removeAllListeners","checkDone","restartBrowser","quitAndInstall","relaunch","exit","getSetting","settingsDb","getSettings","setSetting","getHomePages","plugins","getProtocolDescription","eventsStream","emitStream","setUpdaterState","emit","bits","arch","indexOf","v","datPlugin","event","webAPIs","datInternalAPI","returnValue","downloads","downloadsEvents","getDownloads","pause","resume","cancel","open","showInFolder","registerListener","win","opts","listener","webContents","isHandled","filePath","saveAs","unusedFilename","sync","getFilename","now","Math","random","basename","setSavePath","downloadSpeed","speedometer","toJSON","lastBytes","sumProgress","getSumReceivedBytes","getSumTotalBytes","getReceivedBytes","setProgressBar","receivedBytes","totalBytes","splice","capture","isNoActiveDownloads","isDestroyed","showErrorBox","dock","downloadFinished","unregisterWhenDone","session","removeListener","prependListener","download","Object","assign","downloadURL","d","stat","getSavePath","openItem","showItemInFolder","getURL","isPaused","getTotalBytes","savePath","dlspeed","getActiveDownloads","acc","idCounter","activeRequests","defaultSession","setPermissionRequestHandler","onPermissionRequestHandler","onPermissionResponseHandler","denyAllRequests","req","permission","cb","BrowserWindow","fromWebContents","hostWebContents","oldCb","decision","send","reqId","sender","userDataDir","stateStoreFile","numActiveWindows","jetpack","cwd","createShellWindow","y","width","height","ensureVisibleOnSomeDisplay","restoreState","webRequest","onBeforeRequest","details","callback","parsedUrl","isSafe","subscribe","i","registerShortcut","onTabSelect","onNextTab","onPrevTab","sendToWebContents","onClose","loadURL","getCurrentPosition","position","getPosition","size","getSize","windowWithinBounds","windowState","bounds","restoredState","read","defaultState","screen","getPrimaryDisplay","max","min","visible","getAllDisplays","some","display","isMinimized","isMaximized","write","atomic","tabIndex","darwinMenu","label","role","submenu","accelerator","click","quit","fileMenu","showOpenDialog","properties","files","close","editMenu","selector","viewMenu","historyMenu","windowMenu","beakerDevMenu","getFocusedWindow","reloadIgnoringCache","toggleDevTools","buildWindowMenu","menus","unshift","registerContextMenu","props","menuItems","mediaFlags","editFlags","hasText","selectionText","trim","can","targetWindow","pageURL","callOnElement","js","executeJavaScript","downloadPrompt","defaultPath","srcURL","showSaveDialog","mediaType","filepath","linkURL","clipboard","writeText","copyImageAt","checked","isLooping","hasAudio","isMuted","canToggleControls","isControlsVisible","isEditable","enabled","canPaste","inspectElement","isDevToolsOpened","devToolsWebContents","focus","frameURL","pdesc","contextMenu","menu","Menu","buildFromTemplate","popup","registerFileProtocol","request","slug","shell","openExternal","defaultFaviconBuffer","readFile","buf","logoBuffer","registerBufferProtocol","slice","split","Buffer","catch","queue","commandReceiver","mainWindow","parseSafeUri","uri","setLevel","json","staus","setApplicationMenu","argv","shouldQuit","makeSingleInstance","commandLine","workingDirectory","getAllWindows","restore"],"mappings":"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"}